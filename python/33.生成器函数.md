## 生成器函数

---

### 什么是生成器函数？

生成器函数是Python中用于创建生成器（generator）的一种特殊函数。它与普通函数的区别在于：

- 生成器函数使用`yield`语句返回数据，而不是`return`一次性返回结果。
- 调用生成器函数不会立即执行函数体，而是返回一个生成器对象。
- 生成器对象支持迭代协议，可以逐步“生成”值，实现惰性计算。

简而言之，生成器函数可以让你**按需生成数据，每次产生一个值，不会一次把所有值生成出来，节约内存、提高效率**。

---

### 生成器函数的定义和语法

一个普通函数使用`def`定义，并通过`return`返回结果；而生成器函数同样用`def`定义，但至少有一个`yield`语句。

#### 语法：

```python
def generator_function(args):
    # 若干代码
    yield 表达式
    # 可以有多次yield，也可以有循环
```

调用该函数：

```python
gen = generator_function(args)
```

`gen`为一个生成器对象。

---

### `yield`关键字详解

- `yield`用来“产出”一个值，挂起函数的执行，保留函数的执行状态（包括局部变量、指令指针等）。
- 下一次调用`__next__()`或者使用`for`循环时，函数会从挂起点继续执行，直到遇到下一个`yield`或者函数结束。
- 函数执行结束时，生成器停止迭代，抛出`StopIteration`异常（由循环机制自动捕获处理）。

---

### 简单示例

```python
def count_up_to(n):
    count = 1
    while count <= n:
        yield count
        count += 1
```

使用：

```python
for number in count_up_to(5):
    print(number)
```

输出：

```
1
2
3
4
5
```

---

### 生成器函数 vs 普通函数

| 方面       | 普通函数                     | 生成器函数                       |
| ---------- | ---------------------------- | -------------------------------- |
| 返回值     | 一次性返回（`return`）       | 逐步产生值（`yield`多次）        |
| 内存使用   | 可能一次生成所有结果，占内存 | 惰性计算，节省内存               |
| 可迭代对象 | 返回普通数据（列表、元组等） | 返回生成器对象，支持迭代         |
| 适用场景   | 小数据集、一次生成结果       | 大数据、流式数据处理、无限序列等 |

---

### 生成器的传值和异常处理

生成器支持通过 `.send()` 方法传值给生成器内部，使得生成器更灵活。

例子：

```python
def echo():
    received = yield
    while True:
        received = yield received
```

用法：

```python
gen = echo()
next(gen)            # 激活生成器，运行到第一个yield
print(gen.send('hi')) # 传入'hi'，生成器yield回传'hi'
print(gen.send('bye')) 
```

输出：

```
hi
bye
```

---

### 生成器函数中的`return`语句

- 生成器函数中，可以使用`return`语句退出生成器，`return`后可跟一个值，该值会被包装在`StopIteration`异常中，供外部捕获。
- 这种特性在Python 3.3+支持，可用于协程等高级用法。

---

### 生成器函数的优势和应用场景

### 优势

1. **节省内存**：不需要一次性将所有数据生成存储，占用大量内存。
2. **惰性计算**：只有在需要时才计算，提升效率。
3. **可表达无限序列**：如斐波那契数列、自然数等。
4. **简化异步编程**（协程基础）。

### 应用场景

- 处理大文件逐行读取，例如读大文本文件。
- 网络数据流读取。
- 无限序列生成，如斐波那契数列、素数序列。
- 自定义迭代行为。
- 数据管道、协程。

---

### 复杂示例

生成斐波那契数列的生成器函数：

```python
def fibonacci():
    a, b = 0, 1
    while True:
        yield a
        a, b = b, a + b
```

用法：

```python
fib = fibonacci()
for _ in range(10):
    print(next(fib))
```

输出：

```
0
1
1
2
3
5
8
13
21
34
```

---

### 生成器表达式与生成器函数区别

- **生成器表达式**语法更简洁，类似列表推导式：

```python
gen = (x*x for x in range(5))
print(next(gen))  # 0
print(next(gen))  # 1
```

- **生成器函数**更灵活，可包含复杂业务逻辑，多个`yield`，处理状态。

---

### 总结

| 关键词     | 说明                                             |
| ---------- | ------------------------------------------------ |
| 生成器函数 | 定义中包含`yield`语句的函数，返回生成器对象      |
| `yield`    | 挂起当前函数状态，返回值给调用者，下一次恢复执行 |
| 惰性计算   | 每次请求时生成一个值，避免一次性占用大量内存     |
| 生成器对象 | 迭代器协议实现者，支持`next()`，`send()`等方法   |
| 应用       | 大数据处理、数据流、无限序列、异步编程的基础     |