# Java 迭代器(Iterator)的详细用法

迭代器是 Java 集合框架中用于遍历集合元素的统一方式，它提供了一种标准的方法来访问集合中的元素，而不需要了解底层集合的具体实现。

## 1. 基本迭代器用法

### 1.1 获取迭代器

所有实现了 `Iterable` 接口的集合都可以通过 `iterator()` 方法获取迭代器：

```java
List<String> list = new ArrayList<>();
list.add("Apple");
list.add("Banana");
list.add("Orange");

// 获取迭代器
Iterator<String> iterator = list.iterator();
```

### 1.2 遍历元素

使用 `hasNext()` 和 `next()` 方法遍历：

```java
while (iterator.hasNext()) {
    String fruit = iterator.next();
    System.out.println(fruit);
}
```

## 2. 迭代器核心方法

| 方法 | 描述 |
|------|------|
| `boolean hasNext()` | 检查是否还有更多元素 |
| `E next()` | 返回下一个元素 |
| `void remove()` | 删除最后访问的元素 |
| `default void forEachRemaining(Consumer<? super E> action)` (Java 8+) | 对剩余元素执行操作 |

## 3. 安全删除元素

迭代器的重要优势是可以安全地在遍历时删除元素：

```java
Iterator<String> iterator = list.iterator();
while (iterator.hasNext()) {
    String fruit = iterator.next();
    if (fruit.equals("Banana")) {
        iterator.remove();  // 安全删除当前元素
    }
}
```

**注意**：
- 必须先调用 `next()` 才能调用 `remove()`
- 不能连续调用 `remove()` 而不调用 `next()`
- 这是唯一在遍历时安全修改集合的方式

## 4. Java 8 新增方法

### 4.1 forEachRemaining()

```java
Iterator<String> iterator = list.iterator();
iterator.next(); // 跳过第一个元素
iterator.forEachRemaining(System.out::println); // 处理剩余元素
```

## 5. 特定集合的迭代器

### 5.1 ListIterator (针对 List 接口)

ListIterator 是 Iterator 的子接口，增加了双向遍历和修改功能：

```java
ListIterator<String> listIterator = list.listIterator();

// 正向遍历
while (listIterator.hasNext()) {
    System.out.println(listIterator.next());
}

// 反向遍历
while (listIterator.hasPrevious()) {
    System.out.println(listIterator.previous());
}

// 添加和修改元素
listIterator.add("Grape"); // 添加元素
listIterator.set("Cherry"); // 替换最后访问的元素
```

ListIterator 特有方法：
- `hasPrevious()`
- `previous()`
- `nextIndex()`
- `previousIndex()`
- `add(E e)`
- `set(E e)`

### 5.2 Map 的迭代器

Map 可以通过三种方式获取迭代器：

```java
Map<String, Integer> map = new HashMap<>();
map.put("Apple", 10);
map.put("Banana", 20);

// 1. 遍历键
Iterator<String> keyIterator = map.keySet().iterator();

// 2. 遍历值
Iterator<Integer> valueIterator = map.values().iterator();

// 3. 遍历键值对
Iterator<Map.Entry<String, Integer>> entryIterator = map.entrySet().iterator();
```

## 6. 迭代器使用注意事项

1. **一次性使用**：
   - 迭代器是一次性对象，遍历结束后不能重置
   - 需要重新获取迭代器来重新遍历

2. **并发修改**：
   - 如果在迭代过程中其他线程修改了集合，会抛出 `ConcurrentModificationException`
   - 可以使用 `Collections.synchronizedList()` 包装集合，并在遍历时同步

3. **快速失败(Fail-Fast)**：
   - Java 的迭代器是快速失败的，一旦检测到结构修改就会立即失败

4. **性能考虑**：
   - 对于 `ArrayList`，索引遍历(for循环)比迭代器稍快
   - 对于 `LinkedList`，迭代器遍历比索引遍历高效得多

## 7. 迭代器 vs for-each 循环

for-each 循环实际上是迭代器的语法糖：

```java
// 这两种方式是等价的
for (String fruit : list) {
    System.out.println(fruit);
}

// 等价于
Iterator<String> it = list.iterator();
while (it.hasNext()) {
    String fruit = it.next();
    System.out.println(fruit);
}
```

**区别**：
- for-each 更简洁
- 直接使用迭代器可以调用 `remove()` 方法
- 迭代器可以用于实现自定义的遍历逻辑

## 8. 自定义迭代器

你可以为自己的集合类实现迭代器：

```java
class MyCollection<E> implements Iterable<E> {
    private E[] elements;
    
    @Override
    public Iterator<E> iterator() {
        return new Iterator<E>() {
            private int index = 0;
            
            @Override
            public boolean hasNext() {
                return index < elements.length;
            }
            
            @Override
            public E next() {
                if (!hasNext()) throw new NoSuchElementException();
                return elements[index++];
            }
        };
    }
}
```

迭代器是 Java 集合框架的核心概念之一，理解其原理和用法对于有效使用 Java 集合非常重要。