### **环境图（Environment Diagram）是什么？**
环境图是一种**可视化工具**，用于展示 Python 程序在执行过程中变量、函数和对象的绑定关系。它帮助我们理解：
1. **变量名** 如何绑定到值（对象）。
2. **函数调用** 如何创建新的作用域（帧）。
3. **嵌套作用域**（如函数内部访问全局变量）如何工作。

---

## **1. 环境图的核心组成部分**
环境图主要由两部分组成：
### **(1) 帧（Frame）**
- 每个函数调用都会创建一个新的帧（执行环境）。
- 帧存储该函数的**局部变量**。
- 全局作用域也是一个帧（称为 **Global Frame**）。

### **(2) 对象（Object）**
- 变量名指向的对象（如数字、字符串、列表、函数等）。
- 对象之间可能有引用关系（如列表嵌套列表）。

---

## **2. 环境图示例**
### **示例代码**
```python
x = 10          # 全局变量

def foo(y):
    z = x + y   # 使用全局变量x
    return z

result = foo(5)
```
### **对应的环境图**
```
Global Frame
-----------
x = 10
foo = <function foo>
result = 15

foo Frame (调用时创建)
-----------
y = 5
z = 15
```
**解释**：
1. **Global Frame** 存储 `x` 和 `foo`。
2. 调用 `foo(5)` 时，创建一个新帧（`foo Frame`），存储参数 `y` 和局部变量 `z`。
3. `z = x + y` 中的 `x` 来自全局作用域（Global Frame）。

---

## **3. 环境图的进阶规则**
### **(1) 变量查找顺序（LEGB 规则）**
Python 查找变量时按以下顺序：
1. **L（Local）**：当前函数的局部变量（当前帧）。
2. **E（Enclosing）**：嵌套外层函数的变量（闭包）。
3. **G（Global）**：全局变量（Global Frame）。
4. **B（Built-in）**：内置函数（如 `print`、`len`）。

### **(2) 函数也是对象**
- 函数名（如 `foo`）在 Global Frame 中绑定到一个函数对象。
- 函数可以赋值给其他变量：
  ```python
  bar = foo  # bar 现在指向 foo 函数
  bar(3)     # 等同于 foo(3)
  ```

### **(3) 可变对象的影响**
如果变量指向可变对象（如列表），修改会影响所有引用它的变量：
```python
a = [1, 2]
b = a      # b 和 a 指向同一个列表
b.append(3)
print(a)   # [1, 2, 3]
```
**环境图**：
```
Global Frame
-----------
a = [1, 2, 3]
b = [1, 2, 3]  # 和 a 指向同一个列表对象
```

---

## **4. 环境图的实际应用**
### **(1) 调试代码**
- 当变量值不符合预期时，画环境图可以快速定位问题。
- 例如：
  ```python
  def swap(a, b):
      a, b = b, a
  
  x, y = 1, 2
  swap(x, y)
  print(x, y)  # 输出 1 2（未交换！）
  ```
  **原因**：
  - `swap` 的帧交换的是局部变量 `a` 和 `b`，不影响全局 `x` 和 `y`。

### **(2) 理解闭包**
闭包（函数嵌套）的环境图会更复杂：
```python
def outer():
    x = 10
    def inner():
        return x
    return inner

f = outer()
print(f())  # 10
```
**环境图**：
```python
Global Frame
-----------
outer = <function outer>
f = <function inner>  # 携带 outer 的 x=10

outer Frame (调用时创建)
-----------
x = 10
inner = <function inner>
```
**关键点**：
- `inner` 函数记住了 `outer` 的 `x`（即使 `outer` 已执行完毕）。

---

## **5. 总结**
| 概念            | 说明                                                         |
| --------------- | ------------------------------------------------------------ |
| **帧（Frame）** | 存储函数调用的局部变量，每次调用函数都会创建新帧。           |
| **全局帧**      | 存储全局变量和函数定义。                                     |
| **对象**        | 变量名指向的实际数据（如数字、列表、函数等）。               |
| **变量查找**    | 按 LEGB 规则（Local → Enclosing → Global → Built-in）查找变量。 |
| **可变对象**    | 多个变量可以指向同一个可变对象（如列表），修改会影响所有引用。 |

环境图是理解 Python **变量作用域**、**函数调用** 和 **闭包** 的利器，建议在遇到复杂代码时手动绘制！